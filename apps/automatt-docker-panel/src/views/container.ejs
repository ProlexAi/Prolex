<%
// Template EJS pour la page de détail d'un conteneur
// Affiche les informations complètes, logs, et actions

// Fonction helper pour obtenir la classe CSS du badge
function getStatusBadgeClass(state) {
    if (state.Running) return 'bg-success';
    if (state.Paused) return 'bg-warning';
    if (state.Dead) return 'bg-dark';
    return 'bg-danger';
}

// Fonction helper pour formater les ports
function formatPorts(exposedPorts) {
    if (!exposedPorts || Object.keys(exposedPorts).length === 0) return 'Aucun';
    return Object.keys(exposedPorts).join(', ');
}

// Fonction helper pour formater la mémoire
function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}
%>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Dashboard Docker Automatt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .navbar-brand { font-weight: 600; font-size: 1.5rem; color: white !important; }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        pre {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-label {
            font-weight: 600;
            color: #666;
        }
        .info-value {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .btn-action {
            margin: 0.25rem;
        }
        .exec-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }
        #execOutput {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-boxes"></i>
                Dashboard Docker Automatt
            </a>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-6">
                    <i class="bi bi-box text-primary"></i>
                    <%= container.name %>
                </h1>
                <p class="text-muted">
                    <small>ID: <%= container.shortId %></small>
                </p>
            </div>
            <div class="col-auto">
                <span class="badge <%= getStatusBadgeClass(container.state) %> fs-6">
                    <%= container.state.Running ? 'RUNNING' : container.state.Paused ? 'PAUSED' : 'STOPPED' %>
                </span>
            </div>
        </div>

        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-gear-fill"></i>
                Actions rapides
            </div>
            <div class="card-body">
                <button class="btn btn-success btn-action" onclick="performAction('start')">
                    <i class="bi bi-play-fill"></i> Démarrer
                </button>
                <button class="btn btn-warning btn-action" onclick="performAction('stop')">
                    <i class="bi bi-stop-fill"></i> Arrêter
                </button>
                <button class="btn btn-info btn-action" onclick="performAction('restart')">
                    <i class="bi bi-arrow-clockwise"></i> Redémarrer
                </button>
                <a href="/" class="btn btn-secondary btn-action">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <!-- Container Info -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i>
                Informations du conteneur
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Nom:</span>
                    <span class="info-value"><%= container.name %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value"><%= container.id %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Image:</span>
                    <span class="info-value"><%= container.image %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Créé:</span>
                    <span class="info-value"><%= container.created %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">État:</span>
                    <span class="info-value">
                        Running: <%= container.state.Running ? 'Oui' : 'Non' %> |
                        Paused: <%= container.state.Paused ? 'Oui' : 'Non' %> |
                        Restarting: <%= container.state.Restarting ? 'Oui' : 'Non' %>
                    </span>
                </div>
                <% if (container.state.StartedAt) { %>
                <div class="info-row">
                    <span class="info-label">Démarré:</span>
                    <span class="info-value"><%= new Date(container.state.StartedAt).toLocaleString('fr-FR') %></span>
                </div>
                <% } %>
                <div class="info-row">
                    <span class="info-label">Ports exposés:</span>
                    <span class="info-value"><%= formatPorts(container.config.ExposedPorts) %></span>
                </div>
                <% if (container.config.Hostname) { %>
                <div class="info-row">
                    <span class="info-label">Hostname:</span>
                    <span class="info-value"><%= container.config.Hostname %></span>
                </div>
                <% } %>
                <% if (container.networkSettings.Networks) { %>
                <div class="info-row">
                    <span class="info-label">Réseaux:</span>
                    <span class="info-value">
                        <% Object.keys(container.networkSettings.Networks).forEach(function(net) { %>
                            <%= net %>: <%= container.networkSettings.Networks[net].IPAddress || 'N/A' %><br>
                        <% }); %>
                    </span>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-text"></i>
                Logs (100 dernières lignes)
            </div>
            <div class="card-body">
                <pre><%= container.logs || 'Aucun log disponible' %></pre>
            </div>
        </div>

        <!-- Exec Command (BONUS) -->
        <% if (!container.execDisabled) { %>
        <div class="card">
            <div class="card-header">
                <i class="bi bi-terminal"></i>
                Exécuter une commande
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Attention :</strong> Cette fonctionnalité permet d'exécuter des commandes arbitraires
                    dans le conteneur. À utiliser avec précaution !
                </div>

                <div class="exec-section">
                    <div class="mb-3">
                        <label for="execCommand" class="form-label">Commande à exécuter:</label>
                        <input type="text" class="form-control" id="execCommand"
                               placeholder="Exemple: ls -la /app" value="ls -la">
                    </div>
                    <button class="btn btn-primary" onclick="executeCommand()">
                        <i class="bi bi-play-circle"></i> Exécuter
                    </button>
                </div>

                <div class="mt-3">
                    <strong>Résultat:</strong>
                    <div id="execOutput">Aucune commande exécutée</div>
                </div>
            </div>
        </div>
        <% } else { %>
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    La fonctionnalité d'exécution de commandes est désactivée (DISABLE_EXEC=1)
                </div>
            </div>
        </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const containerId = '<%= container.id %>';

        // Fonction pour effectuer une action (start/stop/restart)
        async function performAction(action) {
            try {
                const response = await fetch(`/api/containers/${containerId}/${action}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`✅ ${result.message}`);
                    // Recharger la page pour voir les changements
                    window.location.reload();
                } else {
                    alert(`❌ Erreur: ${result.message || result.error}`);
                }
            } catch (error) {
                alert(`❌ Erreur réseau: ${error.message}`);
            }
        }

        // Fonction pour exécuter une commande
        async function executeCommand() {
            const command = document.getElementById('execCommand').value;
            const outputDiv = document.getElementById('execOutput');

            if (!command.trim()) {
                alert('Veuillez entrer une commande');
                return;
            }

            outputDiv.textContent = 'Exécution en cours...';

            try {
                const response = await fetch(`/api/containers/${containerId}/exec`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command })
                });

                const result = await response.json();

                if (response.ok) {
                    let output = '';
                    if (result.stdout) {
                        output += '=== STDOUT ===\n' + result.stdout + '\n';
                    }
                    if (result.stderr) {
                        output += '=== STDERR ===\n' + result.stderr + '\n';
                    }
                    output += `\n=== Exit Code: ${result.exitCode || 0} ===`;

                    outputDiv.textContent = output || 'Aucune sortie';
                } else {
                    outputDiv.textContent = `❌ Erreur: ${result.message || result.error}`;
                }
            } catch (error) {
                outputDiv.textContent = `❌ Erreur réseau: ${error.message}`;
            }
        }

        // Permettre d'exécuter avec Enter
        document.getElementById('execCommand')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeCommand();
            }
        });
    </script>
</body>
</html>
