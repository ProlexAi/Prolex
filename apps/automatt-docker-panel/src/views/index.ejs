<%
// Template EJS pour la page d'accueil
// Affiche la liste de tous les conteneurs Docker

// Fonction helper pour obtenir la classe CSS du badge selon l'état
function getStatusBadgeClass(state) {
    const stateMap = {
        'running': 'badge-running',
        'exited': 'badge-exited',
        'paused': 'badge-paused',
        'restarting': 'badge-restarting',
        'dead': 'badge-exited',
        'created': 'badge-paused'
    };
    return stateMap[state.toLowerCase()] || 'bg-secondary';
}

// Fonction helper pour formater les ports
function formatPorts(ports) {
    if (!ports || ports.length === 0) return 'Aucun';

    return ports
        .filter(p => p.PublicPort)
        .map(p => `${p.PublicPort}:${p.PrivatePort}`)
        .join(', ') || 'Aucun public';
}
%>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Dashboard Docker Automatt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
            color: white !important;
        }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        .badge-running { background-color: #28a745; }
        .badge-exited { background-color: #dc3545; }
        .badge-paused { background-color: #ffc107; }
        .badge-restarting { background-color: #17a2b8; }
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
            cursor: pointer;
        }
        .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-boxes"></i>
                Dashboard Docker Automatt
            </a>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-arrow-clockwise"></i> Rafraîchir
                </a>
                <a href="/health" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-heart-pulse"></i> Health
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-5">
                    <i class="bi bi-box-seam text-primary"></i>
                    Conteneurs Docker
                </h1>
                <p class="lead text-muted">
                    Gérez vos conteneurs Docker en un clic
                </p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <%
            const total = containers.length;
            const running = containers.filter(c => c.state === 'running').length;
            const stopped = containers.filter(c => c.state === 'exited').length;
            const paused = containers.filter(c => c.state === 'paused').length;
            %>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-primary"><%= total %></h3>
                        <p class="text-muted mb-0">Total</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-success"><%= running %></h3>
                        <p class="text-muted mb-0">En cours</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-danger"><%= stopped %></h3>
                        <p class="text-muted mb-0">Arrêtés</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-warning"><%= paused %></h3>
                        <p class="text-muted mb-0">En pause</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Containers Table -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i>
                Liste des conteneurs (<%= total %>)
            </div>
            <div class="card-body p-0">
                <% if (containers.length === 0) { %>
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">Aucun conteneur trouvé</p>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Image</th>
                                    <th>Statut</th>
                                    <th>État</th>
                                    <th>Ports</th>
                                    <th>Créé</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% containers.forEach(function(container) { %>
                                    <tr>
                                        <td>
                                            <strong><%= container.name %></strong><br>
                                            <small class="text-muted"><%= container.shortId %></small>
                                        </td>
                                        <td>
                                            <code><%= container.image %></code>
                                        </td>
                                        <td>
                                            <span class="badge <%= getStatusBadgeClass(container.state) %>">
                                                <%= container.state.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <small><%= container.status %></small>
                                        </td>
                                        <td>
                                            <small><%= formatPorts(container.ports) %></small>
                                        </td>
                                        <td>
                                            <small><%= container.created %></small>
                                        </td>
                                        <td>
                                            <a href="/container/<%= container.id %>" class="btn btn-primary btn-sm">
                                                <i class="bi bi-eye"></i> Détails
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-info-circle text-info"></i>
                    À propos
                </h5>
                <p class="card-text">
                    Ce dashboard vous permet de visualiser et gérer vos conteneurs Docker.
                    Cliquez sur "Détails" pour voir les informations complètes d'un conteneur,
                    ses logs, et effectuer des actions (démarrer, arrêter, redémarrer).
                </p>
                <p class="card-text mb-0">
                    <strong>⚠️ Sécurité :</strong> Cette application a accès au socket Docker
                    et peut contrôler tous vos conteneurs. Assurez-vous de la protéger par
                    authentification en production.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer text-center mt-5">
        <div class="container">
            <p class="mb-0">
                <i class="bi bi-gear-fill"></i>
                Dashboard Docker Automatt
            </p>
            <small class="text-muted">
                Propulsé par Node.js + Express + Dockerode
            </small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
