# ===========================================
# docker-compose.example.yml
# ===========================================
#
# Exemple de configuration Docker Compose pour lancer le Dashboard Docker Automatt.
#
# USAGE :
# 1. Copier ce fichier : cp docker-compose.example.yml docker-compose.yml
# 2. Modifier les variables d'environnement selon vos besoins
# 3. Lancer : docker-compose up -d
#
# ⚠️ SÉCURITÉ :
# - Le montage de /var/run/docker.sock donne un contrôle COMPLET sur Docker
# - TOUJOURS activer l'authentification en production (DASHBOARD_BASIC_AUTH_TOKEN)
# - TOUJOURS désactiver exec en production (DISABLE_EXEC=1)
# - TOUJOURS utiliser derrière un reverse proxy avec HTTPS (Traefik, Nginx, etc.)
#

version: "3.9"

services:
  # ===========================================
  # Dashboard Docker Automatt
  # ===========================================
  automatt-docker-panel:
    # Nom du conteneur
    container_name: automatt-docker-panel

    # Construction de l'image depuis le Dockerfile local
    build:
      context: .
      dockerfile: Dockerfile

    # Alternative : utiliser une image pré-buildée
    # image: automatt/docker-panel:latest

    # Port exposé : 8080 sur l'hôte → 8080 dans le conteneur
    # Modifier le premier port si vous voulez utiliser un autre port sur l'hôte
    # Exemple : "3000:8080" pour accéder via http://localhost:3000
    ports:
      - "8080:8080"

    # Variables d'environnement
    environment:
      # ===== Configuration de base =====
      # Port d'écoute du serveur (doit correspondre au port exposé dans le conteneur)
      - PORT=8080

      # Host d'écoute (0.0.0.0 pour écouter sur toutes les interfaces)
      - HOST=0.0.0.0

      # Environnement (development | staging | production)
      - NODE_ENV=production

      # ===== Authentification =====
      # Token d'authentification Bearer
      # ⚠️ IMPORTANT : Changer cette valeur !
      # Si non défini : authentification désactivée (dangereux en production)
      # Si défini : toutes les requêtes doivent fournir ce token dans le header Authorization
      - DASHBOARD_BASIC_AUTH_TOKEN=change_me_to_a_strong_secret_token_123456789

      # ===== Sécurité - Exec =====
      # Désactiver la fonctionnalité d'exécution de commandes dans les conteneurs
      # Valeurs : 1 (désactivé) | 0 (activé)
      # ⚠️ RECOMMANDATION : Toujours mettre à 1 en production
      - DISABLE_EXEC=1

      # ===== Docker Socket =====
      # Chemin vers le socket Docker (ne pas modifier sauf configuration spéciale)
      - DOCKER_SOCKET=/var/run/docker.sock

    # Volumes
    volumes:
      # ⚠️ CRITIQUE : Montage du socket Docker
      # Permet à l'application de communiquer avec le daemon Docker
      # Ce montage donne un contrôle COMPLET sur Docker !
      # Mode 'ro' (read-only) recommandé, mais certaines opérations (start/stop) nécessitent 'rw'
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Politique de redémarrage
    # unless-stopped : redémarre toujours sauf si arrêté manuellement
    restart: unless-stopped

    # Healthcheck
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Labels (utiles pour Traefik, Portainer, etc.)
    labels:
      # Informations générales
      - "com.automatt.app=docker-dashboard"
      - "com.automatt.version=1.0.0"

      # ===== Exemple de configuration Traefik (décommenter si utilisé) =====
      # - "traefik.enable=true"
      # - "traefik.http.routers.docker-dashboard.rule=Host(`docker.example.com`)"
      # - "traefik.http.routers.docker-dashboard.entrypoints=websecure"
      # - "traefik.http.routers.docker-dashboard.tls=true"
      # - "traefik.http.routers.docker-dashboard.tls.certresolver=letsencrypt"
      # - "traefik.http.services.docker-dashboard.loadbalancer.server.port=8080"

      # ===== Middleware Traefik pour l'authentification (optionnel) =====
      # Alternative à DASHBOARD_BASIC_AUTH_TOKEN si vous utilisez Traefik
      # - "traefik.http.routers.docker-dashboard.middlewares=auth"
      # - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$abc123$$xyz"

    # Réseau (optionnel - créer un réseau dédié)
    # networks:
    #   - dashboard_network

# ===== Réseaux (optionnel) =====
# networks:
#   dashboard_network:
#     driver: bridge

# ===========================================
# NOTES D'UTILISATION
# ===========================================
#
# 1. PREMIÈRE UTILISATION :
#    docker-compose up -d
#    docker-compose logs -f
#
# 2. ACCÈS À L'APPLICATION :
#    http://localhost:8080
#
# 3. AUTHENTIFICATION :
#    - Si DASHBOARD_BASIC_AUTH_TOKEN est défini, ajouter le header :
#      Authorization: Bearer <votre_token>
#    - Avec curl :
#      curl -H "Authorization: Bearer change_me_to_a_strong_secret_token_123456789" http://localhost:8080/api/containers
#
# 4. ARRÊT :
#    docker-compose down
#
# 5. MISE À JOUR :
#    docker-compose pull
#    docker-compose up -d
#
# 6. LOGS :
#    docker-compose logs -f automatt-docker-panel
#
# ===========================================
# SÉCURITÉ EN PRODUCTION
# ===========================================
#
# ✅ À FAIRE :
# - Changer DASHBOARD_BASIC_AUTH_TOKEN avec un token fort
# - Mettre DISABLE_EXEC=1
# - Utiliser HTTPS avec Traefik ou Nginx
# - Limiter l'accès réseau (firewall, IP whitelisting)
# - Monitorer les logs
# - Utiliser des secrets Docker au lieu de variables d'environnement en clair
#
# ❌ À NE PAS FAIRE :
# - Exposer directement sur Internet sans authentification
# - Laisser DISABLE_EXEC=0 en production
# - Utiliser HTTP en production
# - Donner accès à des utilisateurs non autorisés
#
