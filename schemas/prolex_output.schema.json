{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://prolex.ai/schemas/prolex_output.schema.json",
  "title": "ProlexOutput",
  "description": "Structure de sortie de l'orchestrateur Prolex après planification",
  "type": "object",
  "properties": {
    "type": {
      "type": "string",
      "description": "Type de réponse Prolex",
      "enum": ["answer", "tool_call", "multi_tool_plan", "clarification"]
    },
    "request_id": {
      "type": "string",
      "description": "ID de la requête originale (provenant de Kimmy)",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "timestamp": {
      "type": "string",
      "description": "Timestamp ISO 8601 de la réponse",
      "format": "date-time"
    },
    "autonomy_level": {
      "type": "integer",
      "description": "Niveau d'autonomie de l'action (voir schemas/autonomy_levels.yml)",
      "minimum": 0,
      "maximum": 3
    },
    "payload": {
      "type": "object",
      "description": "Contenu de la réponse (varie selon le type)"
    },
    "metadata": {
      "type": "object",
      "description": "Métadonnées de traitement",
      "properties": {
        "processing_time_ms": {
          "type": "number",
          "description": "Temps de traitement en millisecondes"
        },
        "model_used": {
          "type": "string",
          "description": "Modèle LLM utilisé (ex: claude-sonnet-4)"
        },
        "tokens_used": {
          "type": "object",
          "properties": {
            "input": {
              "type": "integer"
            },
            "output": {
              "type": "integer"
            }
          }
        },
        "cost_estimate_usd": {
          "type": "number",
          "description": "Coût estimé en USD"
        }
      }
    },
    "reasoning": {
      "type": "string",
      "description": "Explication du raisonnement de Prolex (optionnel, pour debug/audit)"
    },
    "validation_required": {
      "type": "boolean",
      "description": "true si validation humaine requise avant exécution"
    },
    "validation_token": {
      "type": "string",
      "description": "Token UUID pour validation (si validation_required = true)"
    }
  },
  "required": [
    "type",
    "request_id",
    "timestamp",
    "autonomy_level",
    "payload"
  ],
  "oneOf": [
    {
      "properties": {
        "type": { "const": "answer" },
        "payload": {
          "type": "object",
          "properties": {
            "text": {
              "type": "string",
              "description": "Réponse textuelle directe"
            },
            "format": {
              "type": "string",
              "enum": ["plain", "markdown", "html"],
              "default": "markdown"
            }
          },
          "required": ["text"]
        }
      }
    },
    {
      "properties": {
        "type": { "const": "tool_call" },
        "payload": {
          "type": "object",
          "properties": {
            "tool_id": {
              "type": "string",
              "description": "ID du workflow Opex à appeler (ex: 100_10_TASK_CREATE)"
            },
            "parameters": {
              "type": "object",
              "description": "Paramètres à passer au workflow"
            }
          },
          "required": ["tool_id", "parameters"]
        }
      }
    },
    {
      "properties": {
        "type": { "const": "multi_tool_plan" },
        "payload": {
          "type": "object",
          "properties": {
            "plan_id": {
              "type": "string",
              "description": "ID unique du plan"
            },
            "steps": {
              "type": "array",
              "description": "Liste ordonnée des étapes",
              "items": {
                "type": "object",
                "properties": {
                  "step_number": {
                    "type": "integer",
                    "minimum": 1
                  },
                  "tool_id": {
                    "type": "string"
                  },
                  "parameters": {
                    "type": "object"
                  },
                  "description": {
                    "type": "string"
                  },
                  "depends_on": {
                    "type": "array",
                    "description": "Numéros des étapes dont celle-ci dépend",
                    "items": {
                      "type": "integer"
                    }
                  }
                },
                "required": ["step_number", "tool_id", "parameters"]
              }
            }
          },
          "required": ["plan_id", "steps"]
        }
      }
    },
    {
      "properties": {
        "type": { "const": "clarification" },
        "payload": {
          "type": "object",
          "properties": {
            "question": {
              "type": "string",
              "description": "Question de clarification à poser à l'utilisateur"
            },
            "suggestions": {
              "type": "array",
              "description": "Suggestions de réponses",
              "items": {
                "type": "string"
              }
            }
          },
          "required": ["question"]
        }
      }
    }
  ]
}
