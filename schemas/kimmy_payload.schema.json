{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://prolex.ai/schemas/kimmy_payload.schema.json",
  "title": "KimmyPayload",
  "description": "Structure de sortie du filtre intelligent Kimmy après analyse d'une requête utilisateur",
  "type": "object",
  "properties": {
    "request_id": {
      "type": "string",
      "description": "Identifiant unique de la requête (UUID v4)",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "timestamp": {
      "type": "string",
      "description": "Timestamp ISO 8601 de la requête",
      "format": "date-time"
    },
    "user_id": {
      "type": "string",
      "description": "Identifiant de l'utilisateur"
    },
    "intent": {
      "type": "string",
      "description": "Intent détecté (voir schemas/intents/kimmy_intents.yml)",
      "enum": [
        "TASK_HELP",
        "DOC_QUESTION",
        "DEV_HELP",
        "CLIENT_CONTEXT",
        "SYSTEM_STATUS",
        "HIGH_RISK_ACTION",
        "SIMPLE_QUESTION",
        "CLARIFICATION_NEEDED"
      ]
    },
    "confidence": {
      "type": "number",
      "description": "Niveau de confiance de l'intent détecté (0-1)",
      "minimum": 0,
      "maximum": 1
    },
    "context": {
      "type": "object",
      "description": "Contexte extrait de la requête",
      "properties": {
        "client_id": {
          "type": "string",
          "description": "ID du client concerné (si applicable)"
        },
        "project_id": {
          "type": "string",
          "description": "ID du projet concerné (si applicable)"
        },
        "urgency": {
          "type": "string",
          "enum": ["low", "normal", "high", "critical"],
          "default": "normal"
        },
        "entities": {
          "type": "array",
          "description": "Entités nommées extraites",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["person", "date", "url", "file", "tool", "custom"]
              },
              "value": {
                "type": "string"
              }
            },
            "required": ["type", "value"]
          }
        }
      }
    },
    "structured_query": {
      "type": "object",
      "description": "Requête reformulée de manière structurée pour Prolex",
      "properties": {
        "original_text": {
          "type": "string",
          "description": "Texte original de la requête"
        },
        "cleaned_text": {
          "type": "string",
          "description": "Texte nettoyé et normalisé"
        },
        "extracted_params": {
          "type": "object",
          "description": "Paramètres extraits de la requête"
        }
      },
      "required": ["original_text", "cleaned_text"]
    },
    "routing": {
      "type": "object",
      "description": "Instructions de routing pour Prolex",
      "properties": {
        "requires_prolex": {
          "type": "boolean",
          "description": "true si la requête nécessite Prolex, false si Kimmy peut répondre directement"
        },
        "suggested_autonomy_level": {
          "type": "integer",
          "description": "Niveau d'autonomie suggéré (0-3)",
          "minimum": 0,
          "maximum": 3
        },
        "requires_human_validation": {
          "type": "boolean",
          "description": "true si validation humaine requise avant exécution"
        }
      },
      "required": ["requires_prolex", "suggested_autonomy_level"]
    },
    "safety_flags": {
      "type": "object",
      "description": "Indicateurs de sécurité",
      "properties": {
        "is_sensitive": {
          "type": "boolean",
          "description": "true si la requête concerne des données sensibles"
        },
        "is_high_risk": {
          "type": "boolean",
          "description": "true si la requête implique une action à risque"
        },
        "blocked_keywords": {
          "type": "array",
          "description": "Mots-clés déclenchant des alertes de sécurité",
          "items": {
            "type": "string"
          }
        }
      }
    }
  },
  "required": [
    "request_id",
    "timestamp",
    "user_id",
    "intent",
    "confidence",
    "structured_query",
    "routing"
  ]
}
