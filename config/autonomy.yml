# config/autonomy.yml — Version finale Prolex v4.2 (niveau 4 permanent)
# Ce fichier définit le niveau d'autonomie actuel de Prolex
# et les capacités associées à chaque niveau

# ====================================================================
# NIVEAU D'AUTONOMIE ACTUEL
# ====================================================================

# Niveau actuel : 0, 1, 2, 3, ou 4
# À ajuster selon l'environnement et la confiance
prolex_current_autonomy_level: 4

# Configuration niveau 4
autonomy_config:
  current: 4
  max: 4
  mode: full-autonomous
  human_in_the_loop: false
  notification_policy:
    critical_only: true          # > 5000 €, modification rag/rules/, nouveau workflow
    channel: telegram
    admin_id: 123456789          # ID Telegram Matthieu

# ====================================================================
# SÉCURITÉS NIVEAU 4
# ====================================================================

safety:
  max_daily_invoices: 50
  forbidden_paths:
    - "infra/vps-prod/docker-compose.yml"
    - ".env"
    - "mcp/n8n-server/.env"

# ====================================================================
# DÉFINITION DES NIVEAUX (0-4)
# ====================================================================

autonomy_levels:
  # ------------------------------------------------------------------
  # NIVEAU 0 : LECTURE SEULE
  # ------------------------------------------------------------------
  0:
    name: "Lecture seule"
    description: |
      Prolex peut lire et analyser, mais n'exécute aucune action.
      Utilisé pour validation initiale ou environnements ultra-critiques.

    allowed_actions:
      - read_documents      # Lire docs du RAG
      - read_systemjournal  # Consulter SystemJournal
      - analyze_logs        # Analyser patterns dans logs
      - propose_todos       # Proposer des TODO (sans créer)
      - answer_questions    # Répondre aux questions

    forbidden_actions:
      - all_tool_calls      # Aucun tool_call autorisé

    use_cases:
      - "Environnement de test initial"
      - "Audit sans modification"
      - "Démonstration read-only"

  # ------------------------------------------------------------------
  # NIVEAU 1 : LECTURE + LOGS
  # ------------------------------------------------------------------
  1:
    name: "Lecture + Logs"
    description: |
      Prolex peut lire et logger automatiquement.
      Première étape d'autonomie : capacité de tracer ses actions.

    allowed_actions:
      - all_level_0         # Toutes actions niveau 0
      - LOG_APPEND          # Logger dans SystemJournal
      - DOC_CREATE_NOTE     # Créer notes/mémos
      - WEB_SEARCH          # Recherches web
      - HEALTHCHECK_RUN     # Vérifier état services

    forbidden_actions:
      - task_create         # Pas encore de création tâches
      - client_workflows    # Pas de workflows clients
      - git_operations      # Pas d'opérations Git
      - n8n_management      # Pas de gestion workflows

    use_cases:
      - "Environnement de staging"
      - "Prolex en formation"
      - "Collecte de données sans impact"

  # ------------------------------------------------------------------
  # NIVEAU 2 : ACTIONS LOW-RISK
  # ------------------------------------------------------------------
  2:
    name: "Actions low-risk"
    description: |
      Prolex peut exécuter des actions personnelles et low-risk.
      Niveau recommandé pour usage quotidien personnel.

    allowed_actions:
      - all_level_1              # Toutes actions niveau 1
      - TASK_CREATE              # Créer tâches perso
      - TASK_UPDATE              # Modifier tâches
      - CAL_EVENT_CREATE         # Créer événements calendrier
      - DOC_UPDATE               # Modifier docs
      - N8N_WORKFLOW_DESIGN      # Designer workflows (sans créer)
      - CLIENT_MONTHLY_REPORT    # Rapports clients (lecture seule)
      - COST_REPORT_RUN          # Rapports coûts
      - WEEKLY_SUMMARY           # Résumés hebdomadaires
      - N8N_LIST_WORKFLOWS       # Lister workflows

    forbidden_actions:
      - client_workflows         # Pas d'exécution workflows clients
      - git_sync                 # Pas de sync Git
      - n8n_workflow_upsert      # Pas de création/modif workflows
      - backup_run               # Pas de backups

    use_cases:
      - "Usage quotidien Matthieu"
      - "Automatisations personnelles"
      - "Développement et design"

    constraints:
      max_cost_per_request_usd: 0.50
      max_tools_per_plan: 5

  # ------------------------------------------------------------------
  # NIVEAU 3 : ACTIONS AVANCÉES
  # ------------------------------------------------------------------
  3:
    name: "Actions avancées"
    description: |
      Prolex peut gérer des workflows clients et créer des workflows n8n.
      Niveau maximum d'autonomie pour opérations packagées et sécurisées.

    allowed_actions:
      - all_level_2                  # Toutes actions niveau 2
      - CLIENT_WORKFLOW_RUN          # Exécuter workflows clients packagés
      - CLIENT_ONBOARDING            # Onboarding clients
      - GIT_CLONE                    # Cloner repos (sur repos autorisés)
      - GIT_SYNC                     # Sync Git
      - GITHUB_OPEN_PR               # Créer PRs
      - N8N_WORKFLOW_UPSERT          # Créer/modifier workflows (sandbox uniquement)
      - N8N_WORKFLOW_TEST            # Tester workflows
      - BACKUP_RUN                   # Lancer backups (avec limite)

    forbidden_actions:
      - n8n_workflow_promote         # Promotion production = manuel
      - restore_backup               # Restauration = manuel
      - git_operations_production    # Git sur prod = manuel

    use_cases:
      - "Production avec workflows validés"
      - "Gestion multi-clients"
      - "Développement avancé workflows"

    constraints:
      max_cost_per_request_usd: 2.00
      max_tools_per_plan: 10
      sandbox_only_for_n8n: true     # Workflows n8n en sandbox uniquement

  # ------------------------------------------------------------------
  # NIVEAU 4 : AUTONOMIE COMPLÈTE (NOUVEAU)
  # ------------------------------------------------------------------
  4:
    name: "Autonomie complète"
    description: |
      Prolex est en autonomie totale sans validation humaine.
      Niveau de production pour opérations business critiques.
      Alertes critiques seulement (>5000€, modification règles, nouveaux workflows).

    allowed_actions:
      - all_level_3                  # Toutes actions niveau 3
      - N8N_WORKFLOW_PROMOTE         # Promotion production AUTO
      - CLIENT_INVOICE_CREATE        # Création factures clients AUTO
      - RAG_RULES_UPDATE             # Modification règles RAG AUTO
      - N8N_WORKFLOW_DEPLOY_PROD     # Déploiement direct en production
      - GIT_OPERATIONS_PRODUCTION    # Git sur prod AUTO
      - BACKUP_RESTORE               # Restauration backups AUTO (avec alertes)

    forbidden_actions:
      - MODIFY_DOCKER_COMPOSE        # Interdiction docker-compose.yml
      - MODIFY_ENV_FILES             # Interdiction fichiers .env
      - DELETE_PRODUCTION_DATA       # Interdiction suppression données prod

    use_cases:
      - "Production complète sans intervention humaine"
      - "Gestion business autonome 24/7"
      - "Opérations critiques avec alertes seulement"

    constraints:
      max_cost_per_request_usd: 10.00
      max_tools_per_plan: 20
      sandbox_only_for_n8n: false    # Workflows n8n directement en prod
      max_daily_invoices: 50         # Limite factures quotidiennes
      alert_threshold_amount: 5000   # Alerte si montant > 5000€

# ====================================================================
# GARDE-FOUS GLOBAUX
# ====================================================================

global_safeguards:
  # Outils nécessitant TOUJOURS alerte (même niveau 4)
  always_alert_on:
    - AMOUNT_OVER_5000_EUR
    - RAG_RULES_MODIFICATION
    - NEW_WORKFLOW_CREATION
    - BACKUP_RESTORE
    - GIT_OPERATIONS_ON_MAIN_BRANCH

  # Fichiers interdits de modification (même niveau 4)
  forbidden_file_modifications:
    - "infra/vps-prod/docker-compose.yml"
    - ".env"
    - "mcp/n8n-server/.env"
    - "config/system.yml"

  # Limites journalières (niveau 4)
  daily_limits:
    BACKUP_RUN: 10
    WEB_SEARCH: 200
    CLIENT_WORKFLOW_RUN: 100
    CLIENT_INVOICE_CREATE: 50

  # Environnements autorisés par type d'outil
  environment_restrictions:
    n8n_workflows:
      level_2: ["sandbox"]
      level_3: ["sandbox", "staging"]
      level_4: ["sandbox", "staging", "production"]  # Production directe

    git_operations:
      level_2: []
      level_3: ["dev", "staging"]
      level_4: ["dev", "staging", "production"]      # Production directe

# ====================================================================
# CONFIGURATION PAR ENVIRONNEMENT
# ====================================================================

environments:
  development:
    default_autonomy_level: 2
    allow_experimental_tools: true
    log_all_decisions: true

  staging:
    default_autonomy_level: 3
    allow_experimental_tools: false
    log_all_decisions: true

  production:
    default_autonomy_level: 4  # NIVEAU 4 ACTIVÉ EN PRODUCTION
    allow_experimental_tools: false
    log_all_decisions: true
    require_double_confirmation_for_high_risk: false  # Plus de confirmation

# ====================================================================
# ESCALADE VERS HUMAIN (NIVEAU 4)
# ====================================================================

human_escalation:
  # Alertes uniquement (pas de blocage)
  triggers:
    - "Montant facture > 5000 EUR"
    - "Modification fichiers dans rag/rules/"
    - "Création nouveau workflow n8n"
    - "Restauration backup"
    - "Opération Git sur branch main en production"
    - "Erreur répétée > 5 fois sur même action"

  # Canal de notification (alertes uniquement, pas de validation)
  notification_channel: "telegram"
  notification_recipient: "matthieu@automatt.ai"
  telegram_chat_id: 123456789
  block_execution: false  # Alertes seulement, pas de blocage

# ====================================================================
# HISTORIQUE DES CHANGEMENTS
# ====================================================================

changelog:
  - date: "2025-11-22"
    version: "4.2"
    change: "Ajout niveau 4 - Autonomie complète sans validation humaine"
    author: "Matthieu"
    impact: "Prolex peut désormais créer factures, modifier RAG, déployer workflows en production sans validation"

  - date: "2025-11-22"
    version: "4.0"
    change: "Ajout niveaux 0-3 + outils N8N_* + garde-fous"
    author: "Matthieu"
